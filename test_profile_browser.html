<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Database Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .test-pass {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .test-info {
            background-color: #d1ecf1;
            border-color: #17a2b8;
            color: #0c5460;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .sql-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        .summary {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Profile Database Test</h1>
        <p>This tool tests if your profile database is working correctly after applying the schema fix.</p>
        
        <div class="test-info">
            <strong>üìã Before running tests:</strong><br>
            1. Make sure you have applied the SQL fix in your Supabase dashboard<br>
            2. Copy the contents of <code>tmp_rovodev_complete_profile_fix.sql</code> and run it in SQL Editor
        </div>

        <button onclick="runAllTests()" id="runTestsBtn">üöÄ Run All Tests</button>
        <button onclick="showSqlFix()" id="showSqlBtn">üìã Show SQL Fix</button>
        <button onclick="clearResults()" id="clearBtn">üóëÔ∏è Clear Results</button>

        <div id="sqlFix" style="display: none;">
            <h3>SQL Fix to Apply:</h3>
            <div class="sql-box" id="sqlContent">Loading SQL content...</div>
            <p><strong>Instructions:</strong></p>
            <ol>
                <li>Copy the SQL above</li>
                <li>Go to your Supabase dashboard ‚Üí SQL Editor</li>
                <li>Paste and run the SQL</li>
                <li>Come back and run the tests</li>
            </ol>
        </div>

        <div id="testResults"></div>
        <div id="summary" class="summary" style="display: none;"></div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = "https://ksesqwvwppigjpmpjutx.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzZXNxd3Z3cHBpZ2pwbXBqdXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NDgyMzMsImV4cCI6MjA2NzAyNDIzM30.LIbGIDhi_agGTjJyNgCAxEER2LqAezO-c2pphJh38zw";
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let testResults = { passed: 0, failed: 0, tests: [] };

        function logTest(testName, passed, message = '') {
            const result = { testName, passed, message };
            testResults.tests.push(result);
            
            if (passed) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            
            const resultsDiv = document.getElementById('testResults');
            const testDiv = document.createElement('div');
            testDiv.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            testDiv.innerHTML = `
                <strong>${passed ? '‚úÖ' : '‚ùå'} ${testName}</strong>
                ${message ? `<br><small>${message}</small>` : ''}
            `;
            resultsDiv.appendChild(testDiv);
        }

        async function testDatabaseConnectivity() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    logTest('Database Connectivity', false, error.message);
                    return false;
                }
                
                logTest('Database Connectivity', true, 'Successfully connected to Supabase');
                return true;
            } catch (error) {
                logTest('Database Connectivity', false, error.message);
                return false;
            }
        }

        async function checkSchemaStatus() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, user_id, username, full_name, mobile_no, user_type, organization_name, designation, college_name, course_name, end_year, address, bio, created_at, updated_at')
                    .limit(1);
                
                if (error) {
                    if (error.message.includes('column') && error.message.includes('does not exist')) {
                        logTest('Schema Status Check', false, `Missing columns detected. Please apply the SQL fix first.`);
                        return false;
                    } else {
                        logTest('Schema Status Check', false, error.message);
                        return false;
                    }
                }
                
                logTest('Schema Status Check', true, 'All required columns are present');
                return true;
            } catch (error) {
                logTest('Schema Status Check', false, error.message);
                return false;
            }
        }

        async function testCRUDOperations() {
            try {
                const testUserId = '00000000-0000-0000-0000-000000000001';
                
                const testProfile = {
                    user_id: testUserId,
                    username: 'test_user_' + Date.now(),
                    full_name: 'Test User',
                    mobile_no: '+1234567890',
                    user_type: 'student',
                    college_name: 'Test University',
                    course_name: 'Computer Science',
                    end_year: 2025,
                    bio: 'Test bio for database testing'
                };
                
                // Test INSERT
                const { data: insertData, error: insertError } = await supabase
                    .from('profiles')
                    .insert(testProfile)
                    .select()
                    .single();
                
                if (insertError) {
                    logTest('CRUD - Insert', false, insertError.message);
                    return false;
                }
                
                logTest('CRUD - Insert', true, 'Profile inserted successfully');
                
                // Test SELECT
                const { data: selectData, error: selectError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', testUserId)
                    .single();
                
                if (selectError) {
                    logTest('CRUD - Select', false, selectError.message);
                    return false;
                }
                
                logTest('CRUD - Select', true, 'Profile retrieved successfully');
                
                // Test UPDATE
                const { error: updateError } = await supabase
                    .from('profiles')
                    .update({ bio: 'Updated test bio' })
                    .eq('user_id', testUserId);
                
                if (updateError) {
                    logTest('CRUD - Update', false, updateError.message);
                    return false;
                }
                
                logTest('CRUD - Update', true, 'Profile updated successfully');
                
                // Test DELETE (cleanup)
                const { error: deleteError } = await supabase
                    .from('profiles')
                    .delete()
                    .eq('user_id', testUserId);
                
                if (deleteError) {
                    logTest('CRUD - Delete', false, deleteError.message);
                    return false;
                }
                
                logTest('CRUD - Delete', true, 'Profile deleted successfully');
                return true;
                
            } catch (error) {
                logTest('CRUD Operations', false, error.message);
                return false;
            }
        }

        async function testUserTypeConstraint() {
            try {
                const testUserId = '00000000-0000-0000-0000-000000000002';
                
                // Test valid user_type
                const { error: validError } = await supabase
                    .from('profiles')
                    .insert({
                        user_id: testUserId,
                        username: 'constraint_test_' + Date.now(),
                        user_type: 'student'
                    });
                
                if (validError) {
                    logTest('User Type Constraint - Valid', false, validError.message);
                    return false;
                }
                
                logTest('User Type Constraint - Valid', true, 'Valid user_type accepted');
                
                // Cleanup
                await supabase.from('profiles').delete().eq('user_id', testUserId);
                
                return true;
            } catch (error) {
                logTest('User Type Constraint', false, error.message);
                return false;
            }
        }

        async function runAllTests() {
            const runBtn = document.getElementById('runTestsBtn');
            runBtn.disabled = true;
            runBtn.textContent = 'üîÑ Running Tests...';
            
            // Clear previous results
            testResults = { passed: 0, failed: 0, tests: [] };
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            
            // Run tests
            await testDatabaseConnectivity();
            await checkSchemaStatus();
            await testCRUDOperations();
            await testUserTypeConstraint();
            
            // Show summary
            showSummary();
            
            runBtn.disabled = false;
            runBtn.textContent = 'üöÄ Run All Tests';
        }

        function showSummary() {
            const summaryDiv = document.getElementById('summary');
            const successRate = ((testResults.passed / (testResults.passed + testResults.failed)) * 100).toFixed(1);
            
            summaryDiv.innerHTML = `
                <h3>üìä Test Summary</h3>
                <p><strong>‚úÖ Passed:</strong> ${testResults.passed}</p>
                <p><strong>‚ùå Failed:</strong> ${testResults.failed}</p>
                <p><strong>üìà Success Rate:</strong> ${successRate}%</p>
                
                ${testResults.failed === 0 ? 
                    '<div class="test-pass"><strong>üéâ All tests passed!</strong><br>Your profile database is working correctly. You can now use the SimpleProfilePage component safely.</div>' :
                    '<div class="test-fail"><strong>‚ö†Ô∏è Some tests failed.</strong><br>Please apply the SQL fix and try again.</div>'
                }
            `;
            summaryDiv.style.display = 'block';
        }

        function showSqlFix() {
            const sqlDiv = document.getElementById('sqlFix');
            const sqlContent = document.getElementById('sqlContent');
            
            // SQL fix content
            sqlContent.textContent = `-- Complete fix for profiles table schema mismatch
-- This adds all missing columns that SimpleProfilePage.tsx expects

-- Add all missing columns to the profiles table
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS mobile_no TEXT;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS user_type TEXT CHECK (user_type IN ('student', 'professional')) DEFAULT 'student';
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS organization_name TEXT;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS designation TEXT;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS college_name TEXT;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS course_name TEXT;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS end_year INTEGER;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS address TEXT;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS bio TEXT;

-- Add user_id column if it doesn't exist (for compatibility with the component)
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS user_id UUID;

-- Update user_id to match id if it's null
UPDATE profiles SET user_id = id WHERE user_id IS NULL;

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_profiles_user_type ON profiles(user_type);
CREATE INDEX IF NOT EXISTS idx_profiles_user_id ON profiles(user_id);`;
            
            sqlDiv.style.display = sqlDiv.style.display === 'none' ? 'block' : 'none';
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('summary').style.display = 'none';
            testResults = { passed: 0, failed: 0, tests: [] };
        }
    </script>
</body>
</html>
